{% extends 'logged_base.html' %}
{% load static %}
{% block title %}상품 등록{% endblock %}
{% block extrahead %}
<link rel="stylesheet" href="{% static 'css/logged_base.css' %}" />
{% endblock %}
{% block main_content %}
<div class="row gap-3">
    <p class="fw-bold fs-2">상품 목록</p>
    <form action="">
        <table class="table">
            <tbody>
                <tr>
                    <td>
                        <p class="fs-6">검색분류</p>
                    </td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <select id="search-title" class="form-select p-2 w-auto" style="min-width: 216px;">
                                <option value="name">상품명</option>
                                <option value="manage_name">상품명 (관리용)</option>
                                <option value="cafe24_code">카페24 상품코드</option>
                                <option value="smartstore_code">스마트스토어 상품코드</option>
                                <option value="smartstore_channel_code">스마트스토어 채널 상품코드</option>
                                <option value="coupang_code">쿠팡 상품코드</option>
                                <option value="code">상품 분류코드</option>
                                <option value="author">상품 게시자</option>
                            </select>
                            <input id="search-field" class="form-control p-2" style="flex-grow: 1;" />
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <p class="fs-6">카테고리</p>
                    </td>
                    <td>
                        <select id="search-category" class="form-control d-flex align-items-center" multiple="multiple">
                            {% for category in categories %}
                            {% if category.category_parent is None %}
                            <option value="{{ category.id }}">{{ category.category_name }}</option> <!-- 부모 카테고리 추가 -->
                            {% for child_category in categories %}
                            {% if child_category.category_parent == category %}
                            <option value="{{ child_category.id }}" style="padding-left: 20px;">{{
                                category.category_name }} > {{ child_category.category_name }}
                            </option>
                            {% endif %}
                            {% endfor %}
                            {% endif %}
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>
                        <p class="fs-6">상품등록일</p>
                    </td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <select id="search-date-title" class="form-select p-2 w-auto" style="min-width: 128px;">
                                <option value="created">상품등록일</option>
                                <option value="modified">상품수정일</option>
                            </select>
                            <button class="btn btn-outline-secondary p-2 ps-3 pe-3 date-btn" value="today">오늘</button>
                            <button class="btn btn-outline-secondary p-2 ps-3 pe-3 date-btn" value="week">1주일</button>
                            <button class="btn btn-outline-secondary p-2 ps-3 pe-3 date-btn" value="month">1개월</button>
                            <button class="btn btn-outline-secondary p-2 ps-3 pe-3 date-btn"
                                value="3months">3개월</button>
                            <button class="btn btn-outline-secondary p-2 ps-3 pe-3 date-btn" value="year">1년</button>
                            <input type="date" id="search-start-datepicker" class="form-control fs-6 p-2"
                                style="width: 112px;" />
                            <span> ~ </span>
                            <input type="date" id="search-end-datepicker" class="form-control fs-6 p-2"
                                style="width: 112px;" />
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="d-flex mt-3 align-items-center justify-content-center gap-2">
            <button type="submit" class="btn btn-primary p-2" style="width: 80px;">검색</button>
            <button id="search-reset-btn" class="btn btn-outline-secondary p-2" style="width: 80px;">초기화</button>
        </div>
    </form>
    <div id="upload-progress-bar" class="progress mb-3" style="display: none;">
        <div id="upload-progress" class="progress-bar progress-bar-striped progress-bar-animated" 
            role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
            style="width: 0%">
            0%
        </div>
    </div>
    <div class="d-flex justify-content-start gap-2">
        <a href="{% url 'dashboard_product_add' %}" class="btn btn-success ps-3 pe-3 pt-2 pb-2">상품 등록</a>
        <button id="product-upload-btn" class="btn btn-primary pt-2 pb-2 ps-3 pe-3">전체 상품 업로드 / 업데이트</button>
    </div>
    <div class="table-wrapper">
        <table class="table table-hover" id="product-table">
            <thead>
                <tr>
                    <th style="width: 64px;">
                        <input type="checkbox" id="select-all-checkbox" class="form-check-input">
                        <span>선택</span>
                    </th>
                    <th>상품 썸네일</th>
                    <th>상품 분류코드</th>
                    <th>상품명</th>
                    <th>카테고리</th>
                    <th>소비자가</th>
                    <th>판매가</th>
                    <th>공급가</th>
                    <th>게시자</th>
                    <th>생성일</th>
                    <th>수정일</th>
                </tr>
            </thead>
        </table>
    </div>
</div>
<script>
    $(document).ready(function () {
        $('#search-category').select2({
            closeOnSelect: false
        });

        $("#product-table").DataTable({
            processing: true,
            serverSide: true,
            pageLength: 10,
            order: [[2, "desc"]],
            ajax: {
                url: "{% url 'dashboard_product_list' %}",
                data: function (d) {
                    return {
                        draw: d.draw,
                        start: d.start,
                        length: d.length,
                        search_field: $("#search-field").val(),
                        search_title: $("#search-title").val(),
                        search_category: $("#search-category").val() || [],
                        search_date_title: $("#search-date-title").val(),
                        start_date: $("#search-start-datepicker").val(),
                        end_date: $("#search-end-datepicker").val(),
                        order: d.order
                    };
                }
            },
            columns: [
                {
                    render: function (data, type, row) {
                        return `<div class="d-flex justify-content-center" style="width: 64px;"><input type="checkbox" class="select-checkbox form-check-input"></div>`;
                    }
                },
                {
                    data: 'product_thumbnail_image',
                    render: function (data, type, row) {
                        if (data) {
                            return '<img src="' + data + '" alt="Product Thumbnail" style="width: 128px; height: 128px;"/>';
                        } else {
                            return '<span>No image</span>';
                        }
                    }
                },
                { 
                    data: 'product_code',
                    render: function (data, type, row) {
                        return `<p class="text-center" style="width: 96px;">${data}</p>`;
                    }
                },
                { 
                    data: 'product_name',
                    render: function (data, type, row) {
                        return `<p class="text-center" style="width: 192px;">${data}</p>`;
                    }
                },
                {
                    data: 'product_categories',
                    render: function (data, type, row) {
                        return `<p class="text-center" style="width: 192px;">${data}</p>`;
                    }
                },
                {
                    data: 'product_consumer_price',
                    render: function (data, type, row) {
                        return `<p class="text-center" style="width: 72px;">${data.toLocaleString()} 원</p>`;
                    }
                },
                {
                    data: 'product_sell_price',
                    render: function (data, type, row) {
                        return `<p class="text-center" style="width: 72px;">${data.toLocaleString()} 원</p>`;
                    }
                },
                {
                    data: 'product_supply_price',
                    render: function (data, type, row) {
                        return `<p class="text-center" style="width: 72px;">${data.toLocaleString()} 원</p>`;
                    }
                },
                {
                    data: 'product_author',
                    render: function (data, type, row) {
                        return `<p class="text-center" style="width: 84px;">${data}</p>`;
                    }
                },
                {
                    data: 'product_created_datetime',
                    render: function (data, type, row) {
                        const date = new Date(data);
                        return `<p class="text-center" style="width: 72px;">${date.toISOString().slice(0, 10)}</p>`;
                    }
                },
                {
                    data: 'product_modified_datetime',
                    render: function (data, type, row) {
                        const date = new Date(data);
                        var formattedDate = date.toISOString().slice(0, 10);
                        return `<p class="text-center" style="width: 72px;">${formattedDate === "1970-01-01" ? "-" : formattedDate}</p>`;
                    }
                },
            ],
            language: {
                lengthMenu: "_MENU_ 개씩 보기",
                zeroRecords: "일치하는 결과가 없습니다.",
                info: "총 _TOTAL_개 중 _START_부터 _END_까지 표시",
                infoEmpty: "데이터가 없습니다.",
                infoFiltered: "(총 _MAX_개의 데이터에서 필터링됨)",
                search: "검색:",
                paginate: {
                    first: "처음",
                    last: "마지막",
                    next: "다음",
                    previous: "이전"
                }
            }
        }).columns.adjust();

        $(".date-btn").click(function (e) {
            e.preventDefault();
            const date = new Date();
            const endDate = date.toISOString().split('T')[0];
            switch ($(this).val()) {
                case "today":
                    $("#search-start-datepicker, #search-end-datepicker").val(endDate);
                    break;
                case "week":
                    var targetDate = new Date();
                    targetDate.setDate(targetDate.getDate() - 7);
                    var startDate = targetDate.toISOString().split('T')[0]
                    $("#search-start-datepicker").val(startDate);
                    $("#search-end-datepicker").val(endDate);
                    break;
                case "month":
                    var targetDate = new Date();
                    targetDate.setMonth(targetDate.getMonth() - 1);
                    var startDate = targetDate.toISOString().split('T')[0]
                    console.log(targetDate, startDate)
                    $("#search-start-datepicker").val(startDate);
                    $("#search-end-datepicker").val(endDate);
                    break;
                case "3months":
                    var targetDate = new Date();
                    targetDate.setMonth(targetDate.getMonth() - 3);
                    var startDate = targetDate.toISOString().split('T')[0]
                    $("#search-start-datepicker").val(startDate);
                    $("#search-end-datepicker").val(endDate);
                    break;
                case "year":
                    var targetDate = new Date();
                    targetDate.setFullYear(targetDate.getFullYear() - 1);
                    var startDate = targetDate.toISOString().split('T')[0]
                    $("#search-start-datepicker").val(startDate);
                    $("#search-end-datepicker").val(endDate);
                    break;
                default:
                    break;
            }
        });

        $("#search-reset-btn").click(function (e) {
            e.preventDefault();

            $("#search-title").val('name');
            $("#search-field").val('');
            $("#search-category").val('');
            $("#search-date-title").val('created');
            $("#search-start-datepicker").val('');
            $("#search-end-datepicker").val('');
        });
    });

    $("#select-all-checkbox").click(function (e) {
        e.stopPropagation();
        $(".select-checkbox").prop("checked", $(this).prop("checked"));
    });

    // 검색 버튼 클릭 시 테이블 새로고침
    $("form").on("submit", function(e) {
        e.preventDefault();
        $("#product-table").DataTable().ajax.reload();
    });

    $("#product-upload-btn").click(function (e) {
        e.preventDefault();
        
        // 프로그레스 바 초기화 및 표시
        $("#upload-progress").width('0%').text('0%');
        $("#upload-progress-bar").show();
        
        $.ajax({
            url: "{% url 'dashboard_product_list' %}",
            method: "POST",
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: {
                code: "product_upload"
            },
            xhr: function() {
                var xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(evt) {
                    if (evt.lengthComputable) {
                        var percentComplete = evt.loaded / evt.total;
                        var percentValue = Math.round(percentComplete * 100) + '%';
                        $("#upload-progress")
                            .width(percentValue)
                            .text(percentValue);
                    }
                }, false);
                return xhr;
            },
            success: function (response) {
                console.log(response);
                // 성공 시 처리
                $("#upload-progress")
                    .removeClass('progress-bar-animated')
                    .addClass('bg-success')
                    .text('업로드 완료!');
                
                // 3초 후 프로그레스 바 숨김
                setTimeout(function() {
                    $("#upload-progress-bar").hide();
                    $("#upload-progress")
                        .removeClass('bg-success')
                        .addClass('progress-bar-animated');
                }, 3000);
            },
            error: function(xhr, status, error) {
                // 에러 시 처리
                $("#upload-progress")
                    .removeClass('progress-bar-animated')
                    .addClass('bg-danger')
                    .width('100%')
                    .text('업로드 실패');
                
                // 3초 후 프로그레스 바 숨김
                setTimeout(function() {
                    $("#upload-progress-bar").hide();
                    $("#upload-progress")
                        .removeClass('bg-danger')
                        .addClass('progress-bar-animated');
                }, 3000);
            }
        });
    });
</script>
{% endblock %}