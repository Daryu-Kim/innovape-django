{% extends 'logged_base.html' %}
{% load static %}
{% load humanize %}
{% block title %}상품 대시보드{% endblock %}
{% block extrahead %}
<link rel="stylesheet" href="{% static 'css/logged_base.css' %}" />
<link rel="stylesheet" href="{% static 'css/dashboard/home.css' %}" />
{% endblock %}
{% block main_content %}
<div class="row gap-3">
	<p class="fw-bold fs-2">상품 대시보드</p>
	<div class="card p-3 rounded shadow border-info border-2 w-100" style="background-color: #fff;">
		<p class="fw-bold fs-4">
			상품 업로드 정보
		</p>
		<!-- 상품 현황 부분 추가 필요. -->
		<hr class="mt-3 mb-3" />
		<div class="row gap-2">
			<div class="col p-3 card shadow">
				<p>전체 등록 상품</p>
				<p><a href="{% url 'dashboard_product_list' %}" class="me-1 fw-bold fs-5 text-decoration-underline">{{ uploaded_products|intcomma }}</a>개</p>
			</div>
			<div class="col card p-3 shadow">
				<p>품절 임박 상품</p>
				<p><a href="{% url 'dashboard_product_inventory' %}" class="me-1 fw-bold fs-5 text-warning text-decoration-underline">0</a>개</p>
			</div>
			<div class="col card p-3 shadow">
				<p>품절 상품</p>
				<p><a href="{% url 'dashboard_product_outofstock' %}" class="me-1 fw-bold fs-5 text-danger text-decoration-underline">0</a>개</p>
			</div>
		</div>
	</div>
	<div class="custom-grid mt-4 gap-3">
		<div class="card p-3">
			<div class="card-body">
				<h5 class="card-title">카페24 상품 가져오기</h5>
				<p class="card-text keep-all mt-2">현재 시점까지의 모든 카페24 상품의 정보가 담긴 엑셀 파일을 불러옵니다.</p>
				<input type="file" class="form-control p-2 mt-3" id="import-cafe24-file" accept=".csv" />
				<button class="btn btn-primary ps-3 pe-3 pt-1 pb-1 mt-3" id="import-cafe24-btn" >불러오기</a>
			</div>
		</div>
		<div class="card p-3">
			<div class="card-body">
				<h5 class="card-title">카페24 상품 옵션 가져오기</h5>
				<p class="card-text keep-all mt-2">현재 시점까지의 모든 카페24 상품의 옵션 정보가 담긴 엑셀 파일을 불러옵니다.</p>
				<input type="file" class="form-control p-2 mt-3" id="import-cafe24-option-file" accept=".csv" />
				<button class="btn btn-primary ps-3 pe-3 pt-1 pb-1 mt-3" id="import-cafe24-option-btn" >불러오기</a>
			</div>
		</div>
		<div class="card p-3">
			<div class="card-body">
				<h5 class="card-title">상품 URL 동기화하기</h5>
				<p class="card-text keep-all mt-2">현재 시점까지의 모든 상품의 URL 정보가 담긴 엑셀 파일을 불러옵니다.</p>
				<input type="file" class="form-control p-2 mt-3" id="import-url-file" accept=".xls,.xlsx" />
				<button class="btn btn-primary ps-3 pe-3 pt-1 pb-1 mt-3" id="import-url-btn" >불러오기</a>
			</div>
		</div>
		<div class="card p-3">
			<div class="card-body">
				<h5 class="card-title">직원가 자동 세팅</h5>
				<p class="card-text keep-all mt-2">모든 상품의 직원가를 자동으로 세팅합니다.</p>
				<button class="btn btn-primary ps-3 pe-3 pt-1 pb-1 mt-3" id="set-manager-price-btn">세팅하기</a>
			</div>
		</div>
		<div class="card p-3">
			<div class="card-body">
				<h5 class="card-title">상품 목록</h5>
				<p class="card-text keep-all mt-2">등록된 상품의 정보 조회, 수정, 삭제 및 재고 관리 등 다양한 작업을 할 수 있는 메뉴입니다.</p>
				<a href="{% url 'dashboard_product_list' %}" class="btn btn-primary ps-3 pe-3 pt-1 pb-1 mt-3">바로가기</a>
			</div>
		</div>
		<div class="card p-3">
			<div class="card-body">
				<h5 class="card-title">상품 등록</h5>
				<p class="card-text keep-all mt-2">새로운 상품을 추가하고, 기본 정보 및 상세 내용을 입력할 수 있는 기능을 제공합니다.</p>
				<a href="{% url 'dashboard_product_add' %}" class="btn btn-primary ps-3 pe-3 pt-1 pb-1 mt-3">바로가기</a>
			</div>
		</div>
		<div class="card p-3">
			<div class="card-body">
				<h5 class="card-title">상품 카테고리</h5>
				<p class="card-text keep-all mt-2">상품을 분류하여 관리할 수 있도록 카테고리를 생성하고 편집하는 기능을 제공합니다.</p>
				<a href="{% url 'dashboard_product_category' %}" class="btn btn-primary ps-3 pe-3 pt-1 pb-1 mt-3">바로가기</a>
			</div>
		</div>
		<div class="card p-3">
			<div class="card-body">
				<h5 class="card-title">상품 진열</h5>
				<p class="card-text keep-all mt-2">상품의 노출 순서와 진열 방식을 설정하여, 사이트에서 상품이 효과적으로 표시되도록 관리할 수 있는 기능을 제공합니다.</p>
				<a href="{% url 'dashboard_product_display' %}" class="btn btn-primary ps-3 pe-3 pt-1 pb-1 mt-3">바로가기</a>
			</div>
		</div>
		<div class="card p-3">
			<div class="card-body">
				<h5 class="card-title">상품 재고</h5>
				<p class="card-text keep-all mt-2">각 상품의 재고 수량을 실시간으로 확인하고, 입고 및 출고 내역을 관리할 수 있는 기능을 제공합니다.</p>
				<a href="{% url 'dashboard_product_inventory' %}" class="btn btn-primary ps-3 pe-3 pt-1 pb-1 mt-3">바로가기</a>
			</div>
		</div>
		<div class="card p-3">
			<div class="card-body">
				<h5 class="card-title">품절 상품</h5>
				<p class="card-text keep-all mt-2">품절된 상품을 확인하고, 재입고 상태를 업데이트하거나 판매 중지 상태를 설정할 수 있는 기능을 제공합니다.</p>
				<a href="{% url 'dashboard_product_outofstock' %}" class="btn btn-primary ps-3 pe-3 pt-1 pb-1 mt-3">바로가기</a>
			</div>
		</div>
	</div>
</div>
<script>
	$(document).ready(function() {
		$("#import-cafe24-btn").click(function() {
			productFile = $("#import-cafe24-file")[0].files[0];

			if (!productFile) {
				alert("파일을 등록해주세요!");
				return false;
			}

			var formData = new FormData();
			formData.append("product", productFile);

			// 진행 상황을 보여줄 모달 추가
			var modalHtml = `
				<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">상품 업로드 진행 중...</h5>
							</div>
							<div class="modal-body">
								<div class="progress">
									<div class="progress-bar progress-bar-striped progress-bar-animated" 
										role="progressbar" style="width: 0%">0%</div>
								</div>
								<p id="progressStatus" class="mt-2 mb-0">처리 중입니다...</p>
							</div>
						</div>
					</div>
				</div>`;

			$('body').append(modalHtml);
			var progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
			progressModal.show();

			$.ajax({
				url: '{% url "dashboard_product_home" %}',
				type: 'POST',
				timeout: 3600000, // 1시간으로 늘림
				data: formData,
				headers: {
					'X-CSRFToken': '{{ csrf_token }}'
				},
				processData: false,
				contentType: false,
				xhr: function() {
					var xhr = new window.XMLHttpRequest();
					xhr.upload.addEventListener("progress", function(evt) {
						if (evt.lengthComputable) {
							var percentComplete = evt.loaded / evt.total;
							$('.progress-bar').css('width', percentComplete * 100 + '%');
							$('.progress-bar').text(Math.round(percentComplete * 100) + '%');
						}
					}, false);
					return xhr;
				},
				success: function(response) {
					progressModal.hide();
					$('#progressModal').remove();
					alert("카페24 상품 불러오기에 성공했습니다!");
					window.location.reload();
				},
				error: function(xhr, status, error) {
					progressModal.hide();
					$('#progressModal').remove();
					alert("카페24 상품 불러오기에 실패했습니다! 다시 시도해주세요.");
				}
			});
		});

		$("#import-cafe24-option-btn").click(function() {
			productOptionFile = $("#import-cafe24-option-file")[0].files[0];

			if (!productOptionFile) {
				alert("파일을 등록해주세요!");
				return false;
			}

			var formData = new FormData();
			formData.append("product_option", productOptionFile);

			alert("상품 옵션을 불러옵니다.")
			$.ajax({
				url: '{% url "dashboard_product_home" %}',
				type: 'POST',
				timeout: 3600000,
				data: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
				processData: false,
				contentType: false,
				success: function(response) {
					alert("카페24 상품 옵션 불러오기에 성공했습니다!");
					window.location.reload();
				},
				error: function(xhr, status, error) {
					alert("카페24 상품 옵션 불러오기에 실패했습니다!");
				}
			});
		});

		$("#import-url-btn").click(function() {
			urlFile = $("#import-url-file")[0].files[0];

			if (!urlFile) {
				alert("파일을 등록해주세요!");
				return false;
			}

			var formData = new FormData();
			formData.append("url", urlFile);

			// 진행 상황을 보여줄 모달 추가
			var modalHtml = `
				<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">상품 업로드 진행 중...</h5>
							</div>
							<div class="modal-body">
								<div class="progress">
									<div class="progress-bar progress-bar-striped progress-bar-animated" 
										role="progressbar" style="width: 0%">0%</div>
								</div>
								<p id="progressStatus" class="mt-2 mb-0">처리 중입니다...</p>
							</div>
						</div>
					</div>
				</div>`;

			$('body').append(modalHtml);
			var progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
			progressModal.show();

			$.ajax({
				url: '{% url "dashboard_product_home" %}',
				type: 'POST',
				timeout: 3600000, // 1시간으로 늘림
				data: formData,
				headers: {
					'X-CSRFToken': '{{ csrf_token }}'
				},
				processData: false,
				contentType: false,
				xhr: function() {
					var xhr = new window.XMLHttpRequest();
					xhr.upload.addEventListener("progress", function(evt) {
						if (evt.lengthComputable) {
							var percentComplete = evt.loaded / evt.total;
							$('.progress-bar').css('width', percentComplete * 100 + '%');
							$('.progress-bar').text(Math.round(percentComplete * 100) + '%');
						}
					}, false);
					return xhr;
				},
				success: function(response) {
					progressModal.hide();
					$('#progressModal').remove();
					alert("상품 URL 불러오기에 성공했습니다!");
					window.location.reload();
				},
				error: function(xhr, status, error) {
					progressModal.hide();
					$('#progressModal').remove();
					alert("상품 URL 불러오기에 실패했습니다! 다시 시도해주세요.");
				}
			});
		});

		$("#set-manager-price-btn").click(function() {
			alert("직원가 자동 세팅을 시작합니다.");

			$.ajax({
				url: '{% url "dashboard_product_home" %}',
				type: 'POST',
				headers: {
					'X-CSRFToken': '{{ csrf_token }}'
				},
				data: {
					'code': 'set-manager-price'
				},
				success: function(response) {
					alert("직원가 자동 세팅에 성공했습니다!");
					window.location.reload();
				},
				error: function(xhr, status, error) {
					alert("직원가 자동 세팅에 실패했습니다!");
				}
			});
		});
	});
</script>
{% endblock %}