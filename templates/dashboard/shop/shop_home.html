{% extends 'logged_base.html' %}
{% load static %}
{% load humanize %}
{% block title %}
  대시보드
{% endblock %}
{% block extrahead %}
  <link rel="stylesheet" href="{% static 'css/logged_base.css' %}" />
  <link rel="stylesheet" href="{% static 'css/dashboard/home.css' %}" />
{% endblock %}
{% block main_content %}
  <div class="container mt-4">
    <!-- 검색 바 -->
    <div class="search-bar">
        <form class="d-flex" method="get" action="{% url 'dashboard_shop_home' %}">
            <input class="form-control me-2 ps-3 pe-3 pt-2 pb-2" type="search" placeholder="상품명을 입력하세요." aria-label="Search" name="query">
            <button class="btn btn-outline-primary" style="width: 72px;" type="submit">검색</button>
        </form>
    </div>
    <!-- 탭 메뉴 -->
    <ul class="nav nav-tabs mt-3" id="categoryTabs" role="tablist">
      {% for category in categories %}
        <li class="nav-item" role="presentation">
          <button class="nav-link pt-2 pb-2 ps-3 pe-3 {% if forloop.first %}active{% endif %}"
            id="tab-{{ category.id }}"
            data-bs-toggle="tab"
            data-bs-target="#content-{{ category.id }}"
            type="button"
            role="tab"
            aria-controls="content-{{ category.id }}"
            aria-selected="{% if forloop.first %}
              true
            {% else %}
              false
            {% endif %}">
            {{ category.category_name }}
          </button>
        </li>
      {% endfor %}
    </ul>

    <div class="row">
      <div class=" mb-3">
        <div class="card">
          <div class="card-body p-3">
            <h5 class="card-title text-center fw-bold fs-4">추천 상품</h5>
            <div class="row custom-grid mt-3">
              {% for product in recommended_products %}
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex justify-content-center">
                      <img src="{{ product.product_thumbnail_image.url }}" alt="{{ product.product_name }}" class="img-fluid" style="width: 35%; aspect-ratio: 1/1 !important; object-fit: cover;">
                      <div class="p-2 w-100">
                        <p class="card-title fw-bold">{{ product.product_name }}</p>
                        <p class="card-text mt-2 fs-6">{{ product.product_description }}</p>
                        <p class="card-text mt-2">판매가: <span class="text-decoration-line-through text-secondary">{{ product.product_sell_price|intcomma }}원</span></p>
                        <p class="card-text">직원가: <span class="fw-bold text-primary fs-5">{{ product.product_manager_price|intcomma }}원</span></p>
                        <button class="btn btn-outline-primary w-100 p-2 fw-semibold mt-2">상품 상세보기</button>
                      </div>
                    </div>
                    <select class="form-select mt-3 pt-2 pb-2 ps-3 pe-3">
                      <option value="">옵션 선택</option>
                      {% for option in recommended_products_options %}
                        {% if option.product == product %}
                          {% if "빠른출고" not in option.product_option_display_name and "빠른 출고" not in option.product_option_display_name %}
                          <option value="{{ option.product_option_code }}" 
                                  data-option-name="{{ option.product_option_name }}"
                                  data-option-price="{{ option.product_option_price }}">
                            {{ option.product_option_name }}
                          </option>
                          {% endif %}
                        {% endif %}
                      {% endfor %}
                    </select>
                    <div class="selected-options"></div>
                    <button class="btn btn-primary w-100 p-2 mt-2 fw-semibold add-to-cart" 
                            data-product-id="{{ product.product_code }}">
                      장바구니 담기
                    </button>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 탭 컨텐츠 -->
    <div class="tab-content" id="categoryTabsContent">
      {% for category in categories %}
        <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="content-{{ category.id }}" role="tabpanel" aria-labelledby="tab-{{ category.id }}">
          <div class="row">
            {% for subcategory in category.category_set.all %}
              <div class="col-md-4 mb-3">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">{{ subcategory.category_name }}</h5>
                    <p class="card-text">카테고리 코드: {{ subcategory.category_code }}</p>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  <script>
    $(document).ready(function() {
        // 옵션 선택 이벤트
        $('.option-select').on('change', function() {
            if (!$(this).val()) return;
            
            const $select = $(this);
            const $selectedOption = $select.find('option:selected');
            const productId = $select.data('product-id');
            const optionCode = $select.val();
            const optionName = $selectedOption.data('option-name');
            const optionPrice = parseInt($selectedOption.data('option-price'));
            const productPrice = parseInt($select.data('product-price'));
            const totalPrice = productPrice + optionPrice;
            
            // 이미 선택된 옵션인지 확인
            const $selectedOptionsDiv = $select.siblings('.selected-options');
            if ($selectedOptionsDiv.find(`[data-option-code="${optionCode}"]`).length > 0) {
                alert('이미 선택된 옵션입니다.');
                $select.val('');
                return;
            }
            
            // 옵션 아이템 HTML 생성
            const optionHtml = `
                <div class="option-item" data-option-code="${optionCode}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">${optionName}</div>
                            <div class="text-primary">${totalPrice.toLocaleString()}원</div>
                        </div>
                        <button type="button" class="btn-close remove-option"></button>
                    </div>
                    <div class="quantity-control mt-2">
                        <button class="btn btn-outline-secondary btn-sm decrease-quantity">-</button>
                        <input type="number" class="form-control form-control-sm quantity" value="1" min="1">
                        <button class="btn btn-outline-secondary btn-sm increase-quantity">+</button>
                    </div>
                </div>
            `;
            
            $selectedOptionsDiv.append(optionHtml);
            $select.val('');
        });
        
        // 수량 증가 버튼 클릭
        $(document).on('click', '.increase-quantity', function() {
            const $input = $(this).siblings('.quantity');
            $input.val(parseInt($input.val()) + 1);
        });
        
        // 수량 감소 버튼 클릭
        $(document).on('click', '.decrease-quantity', function() {
            const $input = $(this).siblings('.quantity');
            const currentValue = parseInt($input.val());
            if (currentValue > 1) {
                $input.val(currentValue - 1);
            }
        });
        
        // 옵션 제거 버튼 클릭
        $(document).on('click', '.remove-option', function() {
            $(this).closest('.option-item').remove();
        });
        
        // 장바구니 담기 버튼 클릭
        $('.add-to-cart').on('click', function() {
            const $button = $(this);
            const productId = $button.data('product-id');
            const $selectedOptionsDiv = $button.siblings('.selected-options');
            const $optionItems = $selectedOptionsDiv.find('.option-item');
            
            if ($optionItems.length === 0) {
                alert('옵션을 선택해주세요.');
                return;
            }
            
            const cartItems = $optionItems.map(function() {
                return {
                    product_code: productId,
                    option_code: $(this).data('option-code'),
                    quantity: parseInt($(this).find('.quantity').val())
                };
            }).get();
            
            $.ajax({
                url: '{% url "add_to_cart" %}',
                type: 'POST',
                data: JSON.stringify({ items: cartItems }),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.status === 'success') {
                        alert('장바구니에 추가되었습니다.');
                        $selectedOptionsDiv.empty();  // 선택된 옵션 초기화
                    } else {
                        alert(response.message || '장바구니 추가 실패');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    alert('장바구니 추가 중 오류가 발생했습니다.');
                }
            });
        });
        
        // 수량 직접 입력 시 유효성 검사
        $(document).on('change', '.quantity', function() {
            const $input = $(this);
            let value = parseInt($input.val());
            
            // 최소값 보장
            if (isNaN(value) || value < 1) {
                value = 1;
            }
            
            $input.val(value);
        });
    });
  </script>
{% endblock %}
