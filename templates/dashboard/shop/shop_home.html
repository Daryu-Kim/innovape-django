{% extends 'logged_base.html' %}
{% load static %}
{% load humanize %}
{% block title %}
  대시보드
{% endblock %}
{% block extrahead %}
  <link rel="stylesheet" href="{% static 'css/logged_base.css' %}" />
  <link rel="stylesheet" href="{% static 'css/dashboard/shop/home.css' %}" />
{% endblock %}
{% block main_content %}
  <div class="mt-4">
    <!-- 검색 바 -->
    <div class="search-bar">
        <form class="d-flex" method="get" action="{% url 'dashboard_shop_home' %}">
            <input class="form-control me-2 ps-3 pe-3 pt-2 pb-2" type="search" placeholder="상품명을 입력하세요." aria-label="Search" name="query">
            <button class="btn btn-outline-primary" style="width: 72px;" type="submit">검색</button>
        </form>
    </div>
    <!-- 탭 메뉴 -->
    <ul class="nav nav-tabs mt-3" id="categoryTabs" role="tablist">
      <li class="nav-item" role="presentation" data-category-id="recommend">
        <button class="nav-link pt-2 pb-2 ps-3 pe-3 active"
          id="tab-recommend"
          data-bs-toggle="tab"
          data-bs-target="#content-recommend"
          type="button"
          role="tab"
          aria-controls="content-recommend"
          aria-selected="true">
          추천 상품
        </button>
      </li>
      <li class="nav-item" role="presentation" data-category-id="new">
        <button class="nav-link pt-2 pb-2 ps-3 pe-3"
          id="tab-new"
          data-bs-toggle="tab"
          data-bs-target="#content-new"
          type="button"
          role="tab"
          aria-controls="content-new"
          aria-selected="false">
          신상품
        </button>
      </li>
      {% for category in categories %}
        <li class="nav-item" role="presentation" data-category-id="{{ category.id }}">
          <button class="nav-link pt-2 pb-2 ps-3 pe-3"
            id="tab-{{ category.id }}"
            data-bs-toggle="tab"
            data-bs-target="#content-{{ category.id }}"
            type="button"
            role="tab"
            aria-controls="content-{{ category.id }}"
            aria-selected="false">
            {{ category.category_name }}
          </button>
        </li>
      {% endfor %}
    </ul>

    <!-- 탭 컨텐츠 -->
    <div class="tab-content" id="categoryTabsContent">
      <div class="tab-pane fade show active" id="content-recommend" role="tabpanel" aria-labelledby="tab-recommend" data-category-id="recommend">
        <div class="custom-grid mt-3 gap-3"></div>
      </div>
      <div class="tab-pane fade" id="content-new" role="tabpanel" aria-labelledby="tab-new" data-category-id="new">
        <div class="custom-grid mt-3 gap-3"></div>
      </div>
      {% for category in categories %}
      <div class="tab-pane fade" id="content-{{ category.id }}" role="tabpanel" aria-labelledby="tab-{{ category.id }}" data-category-id="{{ category.id }}">
        <div class="custom-grid mt-3 gap-3"></div>
      </div>
      {% endfor %}
    </div>

    <div class="d-flex justify-content-center mt-4">
      <button class="btn btn-link fs-5 text-decoration-none text-secondary" id="next-page">
        <i class="bi bi-chevron-down"></i>&nbsp;더보기
      </button>
    </div>
  </div>

 <!-- 플로팅 버튼 -->
<div class="floating-button" id="floatingButton">
  <i class="bi bi-cart" style="font-size: 24px;"></i> <!-- Font Awesome 아이콘 사용 -->
</div>

<!-- 장바구니 드롭다운 -->
<div class="cart-dropdown p-3" id="cartDropdown" style="display: none;">
  <div class="cart-header">
      <h5 class="fw-bold">장바구니</h5>
      <button class="btn-close" id="closeCartDropdown"></button>
  </div>
  <hr class="mt-3 mb-3">
  <div class="cart-body d-flex flex-column gap-2" id="cartBody">
      <p>장바구니가 비어 있습니다.</p>
  </div>
  <hr class="mt-3 mb-3">
  <div class="cart-footer d-flex justify-content-between align-items-center">
    <div id="totalPrice" class="total-price fw-bold">총 결제금액: 0원</div>
    <button class="btn btn-primary pt-1 pb-1 ps-2 pe-2 fw-medium" id="checkoutButton">결제하기</button>
  </div>
</div>

<!-- 상품 상세 모달 -->
<div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header d-flex justify-content-between align-items-center p-3">
        <h5 class="modal-title fw-bold" id="productDetailModalLabel">상품 상세보기</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="productDetailImages" class="d-flex flex-column">
          <!-- 이미지들이 여기에 동적으로 추가됨 -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 결제 모달 -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg h-75 overflow-y-auto">
      <div class="modal-content d-flex flex-column gap-3" style="background-color: #ddd;">
          <div class="modal-header d-flex justify-content-between align-items-center p-3 bg-light">
              <h5 class="modal-title fw-bold" id="paymentModalLabel">주문서 및 결제</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <div class="bg-light p-3">
                <p class="fw-bold fs-5">상품 수령 방법</p>
                <div class="d-flex align-items-center gap-4 mt-3">
                  <div class="d-flex align-items-center gap-2">
                    <input type="radio" class="form-check-input" style="width: 24px; height: 24px;" id="delivery-method-delivery" name="delivery-method" value="delivery" checked>
                    <label for="delivery-method-delivery" class="form-check-label">택배</label>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <input type="radio" class="form-check-input" style="width: 24px; height: 24px;" id="delivery-method-store-pickup" name="delivery-method" value="store_pickup">
                    <label for="delivery-method-store-pickup" class="form-check-label">스토어 픽업</label>
                  </div>
                </div>
              </div>
              <div class="bg-light p-3 mt-2">
                <p class="fw-bold fs-5">배송지 정보</p>
                <div class="d-flex flex-column gap-3 mt-3">
                  <div class="d-flex gap-2">
                    <p class="mt-3" style="width: 100px;">받는사람 <span class="fw-bold text-primary">*</span></p>
                    <input type="text" class="form-control p-3" id="recipient-name" placeholder="이름을 입력하세요.">
                  </div>
                  <div class="d-flex gap-2">
                    <p class="mt-3" style="width: 100px;">주소 <span class="fw-bold text-primary">*</span></p>
                    <div class="d-flex flex-column gap-2 w-100">
                      <button class="btn btn-outline-primary p-3" id="search-address">주소 검색</button>
                      <input type="text" class="form-control p-3" id="recipient-address-code" placeholder="우편번호를 입력하세요." disabled>
                      <input type="text" class="form-control p-3" id="recipient-address-default" placeholder="주소를 입력하세요." disabled>
                      <input type="text" class="form-control p-3" id="recipient-address-detail" placeholder="상세주소를 입력하세요.">
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <p class="mt-3" style="width: 100px;">휴대폰 <span class="fw-bold text-primary">*</span></p>
                    <div class="d-flex align-items-center gap-3 w-100">
                      <input type="text" class="form-control p-3" id="recipient-phone-1">
                      <p class="fs-5">-</p>
                      <input type="text" class="form-control p-3" id="recipient-phone-2">
                      <p class="fs-5">-</p>
                      <input type="text" class="form-control p-3" id="recipient-phone-3">
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <p class="mt-3" style="width: 100px;">배송메시지</p>
                    <input type="text" class="form-control p-3" id="recipient-message" placeholder="배송 메시지를 입력하세요.">
                  </div>
                </div>
              </div>
              <div class="bg-light p-3 mt-2">
                <p class="fw-bold fs-5">주문 상품 목록</p>
                <div class="d-flex flex-column gap-3 mt-3" id="cart-items"></div> <!-- 장바구니 내용 -->
              </div>
              <div class="bg-light p-3 mt-2">
                <p class="fw-bold fs-5">결제 정보</p>
                <div class="d-flex flex-column gap-2 mt-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <p>주문상품</p>
                    <p class="fw-bold" id="order-product-price">0원</p>
                  </div>
                  <div class="d-flex justify-content-between align-items-center">
                    <p>배송비</p>
                    <p class="fw-bold" id="shipping-fee">0원</p>
                  </div>
                  <div class="d-flex justify-content-between align-items-center mt-1">
                    <p class="fw-bold fs-5">최종 결제 금액</p>
                    <p class="fw-bold fs-4 text-primary" id="total-payment">0원</p>
                  </div>
                </div>
              </div>
              <div class="bg-light p-3 mt-2">
                <p class="fw-bold fs-5">결제 수단</p>
                <div class="d-flex flex-column gap-2 mt-3">
                  <div class="d-flex gap-2">
                    <p class="mt-3" style="width: 100px;">입금은행 <span class="fw-bold text-primary">*</span></p>
                    <select class="form-select p-3" id="deposit-bank">
                      <option value="-1">::: 선택해 주세요. :::</option>
                      <option value="bank_82:3021478397531:김원재:농협회원조합:banking.nonghyup.com">농협회원조합 3021478397531 김원재</option>
                      <option value="bank_26:110541495464:김원재:신한은행:www.shinhan.com">신한은행 110541495464 김원재</option>
                      <option value="bank_293:3333139468706:김원재:카카오뱅크:www.kakaobank.com">카카오뱅크 3333139468706 김원재</option>
                      <option value="bank_31:508144949415:김원재:iM뱅크:www.dgb.co.kr">iM뱅크 508144949415 김원재</option>
                    </select>
                  </div>
                  <div class="d-flex gap-2">
                    <p class="mt-3" style="width: 100px;">입금자명 <span class="fw-bold text-primary">*</span></p>
                    <input type="text" class="form-control p-3" id="deposit-name" placeholder="이름을 입력하세요.">
                  </div>
                </div>
              </div>
          </div>
          <div class="modal-footer bg-light p-3 d-flex align-items-center gap-2">
              <button type="button" class="btn btn-secondary pt-2 pb-2 ps-3 pe-3" data-bs-dismiss="modal">취소</button>
              <button type="button" class="btn btn-primary pt-2 pb-2 ps-3 pe-3" id="confirm-order">주문하기</button>
          </div>
      </div>
  </div>
</div>
  <script>
    $(document).ready(function() {
      let currentPage = 1;
      $(document).on('click', '#checkoutButton', async function() {
        try {
            const cartItems = await getCartItems(); // 장바구니에서 상품 정보를 가져오는 함수
            const userInfo = await getUserInfo(); // 사용자 정보를 비동기적으로 가져옴
            console.log('User Info:', userInfo);  // 디버깅용 로그 추가

            if (!userInfo || !userInfo.name) {
                alert('사용자 정보를 불러오는 데 실패했습니다.');
                return;  // 사용자 정보가 없으면 함수 종료
            }

            // 장바구니 내용 표시
            const $cartItemsContainer = $('#cart-items');
            $cartItemsContainer.empty(); // 기존 내용 비우기
            $.each(cartItems, function(index, item) {
                $cartItemsContainer.append(`
                    <div class="d-flex gap-3">
                      <div class="border">
                        <img src="${item.product_thumbnail_image}" alt="${item.product_name}" class="img-fluid" style="width: 96px; aspect-ratio: 1/1 !important; object-fit: cover;">
                      </div>
                      <div>
                        <p class="fw-bold" style="font-size: 14px;">${item.product_name}</p>
                        <p class="text-secondary mt-2" style="font-size: 12px;">옵션: ${item.option_name}</p>
                        <p class="text-secondary" style="font-size: 12px;">수량: ${item.quantity.toLocaleString()}개</p>
                        <p class="fw-medium mt-2" style="font-size: 13px;">가격: ${item.total_price.toLocaleString()}원</p>
                      </div>
                    </div>
                `);
                if (index < cartItems.length - 1) {
                  $cartItemsContainer.append('<hr class="mt-1 mb-1 border-secondary">');
                }
            });

            // 사용자 정보 표시
            $('#recipient-name').val(userInfo.name);
            $('#recipient-address-code').val(userInfo.address_code);
            $('#recipient-address-default').val(userInfo.address_default);
            $('#recipient-address-detail').val(userInfo.address_detail);
            $('#recipient-phone-1').val(function() {
                const phone = userInfo.phone.replace(/\D/g, ''); // 숫자 이외의 문자 제거
                let formattedPhone = phone;
                
                if (phone.length === 11) {
                    // 3-4-4 포맷
                    formattedPhone = phone.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
                    $('#recipient-phone-2').val(formattedPhone.split('-')[1]);
                    $('#recipient-phone-3').val(formattedPhone.split('-')[2]);
                } else if (phone.length === 12) {
                    // 4-4-4 포맷
                    formattedPhone = phone.replace(/(\d{4})(\d{4})(\d{4})/, '$1-$2-$3');
                    $('#recipient-phone-2').val(formattedPhone.split('-')[1]);
                    $('#recipient-phone-3').val(formattedPhone.split('-')[2]);
                }
                
                return formattedPhone.split('-')[0];
            });
            $('#deposit-name').val(userInfo.name);

            // 배송비 계산
            $('#order-product-price').text(`${cartItems.reduce((total, item) => total + item.total_price, 0).toLocaleString()}원`);
            updateShippingFee();

            // 모달 표시
            $('#paymentModal').modal('show');
        } catch (error) {
            console.error('Error:', error);
            alert('사용자 정보를 불러오는 데 문제가 발생했습니다!');
        }
      });

      $(document).on('click', '#search-address', function() {
        new daum.Postcode({
            oncomplete: function(data) {
                var roadAddr = data.roadAddress;
                var extraRoadAddr = '';

                if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                    extraRoadAddr += data.bname;
                }
                if(data.buildingName !== '' && data.apartment === 'Y'){
                    extraRoadAddr += (extraRoadAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                }
                if(extraRoadAddr !== ''){
                    extraRoadAddr = ' (' + extraRoadAddr + ')';
                }

                $('#recipient-address-code').val(data.zonecode);
                $('#recipient-address-default').val(roadAddr);
                
                if(roadAddr !== ''){
                    $('#recipient-address-detail').val(extraRoadAddr);
                } else {
                    $('#recipient-address-detail').val('');
                }
            }
        }).open();
      });

      $(document).on('click', '#confirm-order', function() {
        const deliveryMethod = $('input[name="delivery-method"]:checked').val();
        const shippingFee = deliveryMethod === 'delivery' ? 3000 : 0;

        if ($('#recipient-name').val() === '' || $('#recipient-address-code').val() === '' || $('#recipient-address-default').val() === '' || $('#recipient-address-detail').val() === '' || $('#recipient-phone-1').val() === '' || $('#recipient-phone-2').val() === '' || $('#recipient-phone-3').val() === '' || $('#deposit-bank').val() === '-1' || $('#deposit-name').val() === '') {
          alert('모든 필수 항목을 입력해주세요.');
          return;
        }
    
        // 주문 정보 수집
        const orderData = {
            deliveryMethod: deliveryMethod,
            shippingFee: shippingFee,
            recipientName: $('#recipient-name').val(),
            recipientAddressCode: $('#recipient-address-code').val(),
            recipientAddressDefault: $('#recipient-address-default').val(),
            recipientAddressDetail: $('#recipient-address-detail').val(),
            recipientPhone: $('#recipient-phone-1').val() + '-' + $('#recipient-phone-2').val() + '-' + $('#recipient-phone-3').val(),
            recipientMessage: $('#recipient-message').val(),
            depositBank: $('#deposit-bank').val(),
            depositName: $('#deposit-name').val(),
        };
    
        // AJAX 요청으로 주문 처리
        $.ajax({
            url: '{% url "dashboard_shop_home" %}',
            type: 'POST',
            contentType: 'application/json',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'
            },
            data: JSON.stringify({ code: "confirm_order", order_data: orderData }),
            success: function(response) {
                // 주문 성공 처리
                alert('주문이 완료되었습니다!');
                $('#paymentModal').modal('hide');  // 모달 닫기
                location.reload();
            },
            error: function(xhr, status, error) {
                // 주문 실패 처리
                alert('주문 처리 중 오류가 발생했습니다.');
            }
        });
      });

      function getCartItems() {
        return new Promise((resolve, reject) => {
          $.ajax({
            url: '{% url "dashboard_shop_home" %}',
            type: 'POST',
            data: JSON.stringify({ code: "get_order_cart_items" }),
            contentType: 'application/json',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
              resolve(response.items);
            },
            error: function(xhr, status, error) {
              console.error('Error loading cart items:', error);
              reject(error);
            }
          });
        });
      }

      function getUserInfo() {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '{% url "dashboard_shop_home" %}',
                type: 'POST',
                data: JSON.stringify({ code: "get_user_info" }),
                contentType: 'application/json',
                headers: {
                  'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    resolve(response.user_info);  // 성공 시 사용자 정보 반환
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching user info:', error);
                    reject(error);  // 실패 시 오류 반환
                }
            });
        });
      }
      
      // 배송비 업데이트 함수
      function updateShippingFee() {
        const deliveryMethod = $('input[name="delivery-method"]:checked').val();
        const shippingFee = deliveryMethod === 'delivery' ? 3000 : 0;
        const totalPrice = parseInt($('#order-product-price').text().replace('원', '').replace(',', ''));
        $('#shipping-fee').text(`${shippingFee.toLocaleString()}원`);
        $('#total-payment').text(`${(totalPrice + shippingFee).toLocaleString()}원`);
      }
      
      // 수령 방법 변경 시 배송비 업데이트
      $(document).on('change', 'input[name="delivery-method"]', function() {
          updateShippingFee();
      });
      // 탭 메뉴 클릭 이벤트
      $('.nav-link').on('click', function() {
        currentPage = 1;
        const categoryId = $(this).closest('.nav-item').data('category-id');
        console.log(categoryId);
        loadTabProducts(categoryId, 1);
      });

      $('#next-page').on('click', function() {
        currentPage += 1;
        const categoryId = $('.tab-pane.active').data('category-id');
        console.log(currentPage);
        loadTabProducts(categoryId, currentPage);
      });

      function loadTabProducts(categoryId, page) {
        $.ajax({
          url: '{% url "dashboard_shop_home" %}',
          type: 'POST',
          data: JSON.stringify({ code: "load_tab_products", category_id: categoryId, page: page }),
          contentType: 'application/json',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          },
          success: function(response) {
            if (response.status === 'success') {
              const $tabContent = $('.tab-pane[data-category-id="' + categoryId + '"] > .custom-grid');
              if (currentPage === 1) {
                $tabContent.empty();
              }
              response.products.forEach(product => {
                const productOptions = product.options || [];
                const filteredOptions = productOptions.filter(option => option.product_code === product.product_code);
                $tabContent.append(`
                  <div>
                    <div class="d-flex justify-content-center">
                      <img src="${product.product_thumbnail_image}" alt="${product.product_name}" class="img-fluid" style="width: 35%; aspect-ratio: 1/1 !important; object-fit: cover;">
                      <div class="ms-3">
                        <p class="card-title fw-bold">${product.product_name}</p>
                        <p class="card-text mt-2 fs-6">${product.product_description}</p>
                        <p class="card-text mt-2">판매가: <span class="text-decoration-line-through text-secondary">${product.product_sell_price.toLocaleString()}원</span></p>
                        <p class="card-text">직원가: <span class="fw-bold text-primary fs-5">${product.product_manager_price.toLocaleString()}원</span></p>
                        <button class="btn btn-outline-primary w-100 p-2 fw-semibold mt-2 view-details" 
                                data-product-details="${product.product_detail}"
                                data-product-name="${product.product_name}">
                            상품 상세보기
                        </button>
                      </div>
                    </div>
                    <select
                      class="form-select mt-3 pt-2 pb-2 ps-3 pe-3 option-select"
                      data-product-id="${product.product_code}"
                      data-product-name="${product.product_name}"
                      data-product-price="${product.product_manager_price}"
                    >
                      <option class="option-select" value="">옵션 선택</option>
                      ${filteredOptions.map(option => `
                          <option value="${option.product_option_code}" 
                                  data-option-name="${option.product_option_name}"
                                  data-option-price="${option.product_option_price}">
                            ${option.product_option_price > 0 ? `${option.product_option_name} (${option.product_option_price.toLocaleString()}원)` : option.product_option_name}
                          </option>
                      `).join('')}
                    </select>
                    <div class="selected-options p-2 d-flex flex-column gap-2"></div>
                    <button class="btn btn-primary w-100 p-2 mt-2 fw-semibold add-to-cart" 
                            data-product-id="${product.product_code}">
                      장바구니 담기
                    </button>
                  </div>
                `);
              });

              if (response.is_last_page) {
                $('#next-page').hide();
              } else {
                $('#next-page').show();
              }
            }
          }
        });
      }

        // 옵션 선택 이벤트
        $(document).on('change', '.option-select', function() {
            if (!$(this).val()) return;
            
            const $select = $(this);
            const $selectedOption = $select.find('option:selected');
            const productId = $select.data('product-id');
            const optionCode = $select.val();
            const optionName = $selectedOption.data('option-name');
            const optionPrice = parseInt($selectedOption.data('option-price')) > 0 ? parseInt($selectedOption.data('option-price')) : 0;
            const productPrice = parseInt($select.data('product-price'));
            const basePrice = productPrice + optionPrice;  // 기본 가격 (1개 기준)
            
            // 이미 선택된 옵션인지 확인
            const $selectedOptionsDiv = $select.siblings('.selected-options');
            if ($selectedOptionsDiv.find(`[data-option-code="${optionCode}"]`).length > 0) {
                alert('이미 선택된 옵션입니다.');
                $select.val('');
                return;
            }
            
            // 옵션 아이템 HTML 생성
            const optionHtml = `
                <div class="option-item" data-option-code="${optionCode}" data-base-price="${basePrice}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">${optionName}</div>
                            <div class="quantity-control mt-2 d-flex align-items-center gap-2" style="width: fit-content !important;">
                                <button class="btn btn-outline-secondary decrease-quantity" style="width: 24px; height: 24px; font-size: 12px;">-</button>
                                <input type="number" class="form-control form-control-sm quantity ps-2 pe-2" value="1" min="1" style="width: 48px; font-size: 12px;">
                                <button class="btn btn-outline-secondary increase-quantity" style="width: 24px; height: 24px; font-size: 12px;">+</button>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="text-primary text-align-end option-total-price">${basePrice.toLocaleString()}원</div>
                            <button type="button" class="btn-close remove-option"></button>
                        </div>
                    </div>
                </div>
            `;
            
            $selectedOptionsDiv.append(optionHtml);
            $select.val('');
        });


        function updatePrice($optionItem) {
          const basePrice = parseInt($optionItem.data('base-price'));
          const quantity = parseInt($optionItem.find('.quantity').val());
          const totalPrice = basePrice * quantity;
          $optionItem.find('.option-total-price').text(totalPrice.toLocaleString() + '원');
        }
        
        // 수량 증가 버튼 클릭
        $(document).on('click', '.increase-quantity', function() {
            const $input = $(this).siblings('.quantity');
            $input.val(parseInt($input.val()) + 1);
            updatePrice($(this).closest('.option-item'));
        });
        
        // 수량 감소 버튼 클릭
        $(document).on('click', '.decrease-quantity', function() {
            const $input = $(this).siblings('.quantity');
            const currentValue = parseInt($input.val());
            if (currentValue > 1) {
                $input.val(currentValue - 1);
                updatePrice($(this).closest('.option-item'));
            }
        });
        
        // 옵션 제거 버튼 클릭
        $(document).on('click', '.remove-option', function() {
            $(this).closest('.option-item').remove();
        });
    
        // 수량 직접 입력 시
        $(document).on('change', '.quantity', function() {
            const $input = $(this);
            let value = parseInt($input.val());
            
            // 최소값 보장
            if (isNaN(value) || value < 1) {
                value = 1;
            }
            
            $input.val(value);
            updatePrice($(this).closest('.option-item'));
        });
        
        // 장바구니 담기 버튼 클릭
        $(document).on('click', '.add-to-cart', function() {
            const $button = $(this);
            const productId = $button.data('product-id');
            const $selectedOptionsDiv = $button.siblings('.selected-options');
            const $optionItems = $selectedOptionsDiv.find('.option-item');
            
            if ($optionItems.length === 0) {
                alert('옵션을 선택해주세요.');
                return;
            }
            
            const cartItems = $optionItems.map(function() {
                return {
                    product_code: productId,
                    option_code: $(this).data('option-code'),
                    quantity: parseInt($(this).find('.quantity').val())
                };
            }).get();
            
            $.ajax({
                url: '{% url "dashboard_shop_home" %}',
                type: 'POST',
                data: JSON.stringify({ code: "add_to_cart", items: cartItems }),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.status === 'success') {
                        alert('장바구니에 추가되었습니다.');
                        $selectedOptionsDiv.empty();  // 선택된 옵션 초기화
                    } else {
                        alert(response.message || '장바구니 추가 실패');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    alert('장바구니 추가 중 오류가 발생했습니다.');
                }
            });
        });
        
        // 수량 직접 입력 시 유효성 검사
        $(document).on('change', '.quantity', function() {
            const $input = $(this);
            let value = parseInt($input.val());
            
            // 최소값 보장
            if (isNaN(value) || value < 1) {
                value = 1;
            }
            
            $input.val(value);
        });

        // 상품 상세보기 버튼 클릭 이벤트
        $(document).on('click', '.view-details', function() {
            const $button = $(this);
            const rawData = $button.attr('data-product-details').split(',');

            const productName = $button.data('product-name');

            // 모달 제목 설정
            $('#productDetailModalLabel').text(productName);

            // 상세 이미지 컨테이너 초기화
            const $detailContainer = $('#productDetailImages').empty();

            if (!rawData || rawData.length === 0) {
                $detailContainer.append('<p class="text-center">상세 이미지가 없습니다.</p>');
            } else {
                // 상세 이미지 추가
                rawData.forEach(imageUrl => {
                    const fullImageUrl = "/media/" + imageUrl;  // 이미지 URL 생성

                    const $img = $('<img>', {
                        src: fullImageUrl,
                        class: 'img-fluid',
                        alt: productName
                    });
                    $detailContainer.append($img);
                });
            }

            // 모달 표시
            $('#productDetailModal').modal('show');
        });

      // 플로팅 버튼 클릭 시 드롭다운 토글
      $('#floatingButton').on('click', function() {
          $('#cartDropdown').toggle();
          loadCartItems();
      });

      // 드롭다운 닫기 버튼 클릭 시 드롭다운 숨기기
      $('#closeCartDropdown').on('click', function() {
          $('#cartDropdown').hide();
      });

      // 장바구니 내용 로드
      function loadCartItems() {
        $.ajax({
            url: '{% url "dashboard_shop_home" %}', // 장바구니 아이템을 가져오는 URL
            type: 'POST',
            data: JSON.stringify({ code: "get_cart_items" }),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
                const $cartBody = $('#cartBody');
                $cartBody.empty(); // 기존 내용 초기화
                let totalAmount = 0;

                if (response.items.length === 0) {
                    $cartBody.append('<p>장바구니가 비어 있습니다.</p>');
                } else {
                    response.items.forEach(item => {
                        $cartBody.append(`
                            <div class="cart-item" data-product-code="${item.product_code}">
                                <p class="fw-bold">${item.product_name}</p>
                                <div class="d-flex flex-column gap-1">
                                ${item.options.map(option => `
                                  <div class="d-flex justify-content-between align-items-center">
                                    <p class="ms-3">${option.option_name} ${option.quantity.toLocaleString()}개 - ${option.total_price.toLocaleString()}원</p>
                                    <button class="btn btn-danger btn-sm remove-option" style="width: 24px; height: 24px; font-size: 12px;" data-option-code="${option.option_code}">X</button>
                                  </div>
                                `).join('')}
                                </div>
                            </div>
                        `);
                        totalAmount += item.total_price;
                    });
                }
                $('#totalPrice').text(`총 결제금액: ${totalAmount.toLocaleString()}원`);
            },
            error: function(xhr, status, error) {
                console.error('Error loading cart items:', error);
            }
        });
    }

    $(document).on('click', '.remove-option', function() {
      const optionCode = $(this).data('option-code'); // 클릭한 버튼의 옵션 ID 가져오기
      const $optionItem = $(this).closest('.cart-item'); // 해당 옵션이 포함된 항목 찾기
  
      // 필요한 정보 가져오기
      const productCode = $optionItem.data('product-code'); // product ID
      const productOptionCode = optionCode; // product option ID
  
      // AJAX 요청을 통해 서버에 옵션 제거 요청을 보냄
      $.ajax({
          url: '{% url "dashboard_shop_home" %}', // 옵션 제거를 처리하는 URL
          type: 'POST',
          data: JSON.stringify({
              code: "remove_cart_item",
              product_code: productCode,
              product_option_code: productOptionCode
          }),
          contentType: 'application/json',
          headers: {
              'X-CSRFToken': '{{ csrf_token }}'
          },
          success: function(response) {
              // 성공적으로 제거된 경우 UI 업데이트
              loadCartItems(); // 장바구니 아이템을 다시 로드하여 업데이트
          },
          error: function(xhr, status, error) {
              console.error('Error removing option:', error);
          }
        });
    });

    // 페이지 로드 시 장바구니 아이템 로드
    loadCartItems();
    loadTabProducts('recommend', 1);
  });
  </script>
{% endblock %}
